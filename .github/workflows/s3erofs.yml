name: s3erofs

on:
  schedule:
    # run at CST 9:00 and 21:00
    - cron:  '0 1,13 * * *'
  # Allows to run this workflow manually from the Actions tab
  workflow_dispatch:

defaults:
  run:
    shell: bash

jobs:
  build-erofs-utils:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - name: Build erofs-utils
        run: |
          sudo apt -qq update
          sudo apt-get install -y libselinux1-dev libcurl4-openssl-dev libxml2-dev libssl-dev
          curl -L https://github.com/lz4/lz4/archive/refs/tags/v1.9.4.tar.gz | tar -zxv
          make BUILD_SHARED=no -C lz4-1.9.4 && lz4libdir=$(pwd)/lz4-1.9.4/lib
          git clone ${{ vars.EROFSUTILS_SOURCE_URL }} -b experimental erofs-utils
          cd erofs-utils
          mkdir output
          ./autogen.sh && ./configure --enable-debug --enable-werror --with-selinux \
              --enable-s3 --with-libcurl --with-libxml2 --with-openssl \
              --prefix=$(pwd)/output \
              --with-lz4-incdir=${lz4libdir} --with-lz4-libdir=${lz4libdir} && \
              make && make install
      - name: Upload erofs-utils
        uses: actions/upload-artifact@v4
        with:
          name: erofs-utils
          path: |
            erofs-utils/output

  erofs-s3-smoking:
    runs-on: ubuntu-22.04
    needs: build-erofs-utils
    strategy:
      matrix:
        urlstyle: [path, vhost]
        sig: [2, 4]
        opts: [""]
        include:
          - urlstyle: vhost
            sig: 4
            opts: "-zlz4hc,12"
          - urlstyle: vhost
            sig: 4
            opts: "--chunksize=65536"
          - urlstyle: vhost
            sig: 4
            opts: "-Enoinline_data"
    steps:
      - uses: actions/checkout@v4
      - name: Download erofs-utils prebuilts
        uses: actions/download-artifact@v4
        with:
          name: erofs-utils
      - name: Setup MinIO (S3-compatible storage)
        run: |
          # Download and setup MinIO server
          wget -q https://dl.min.io/server/minio/release/linux-amd64/minio
          chmod +x minio
          
          # Download MinIO client (mc)
          wget -q https://dl.min.io/client/mc/release/linux-amd64/mc
          chmod +x mc
          
          # Start MinIO server in background
          mkdir -p minio-data
          MINIO_ROOT_USER=minioadmin MINIO_ROOT_PASSWORD=minioadmin MINIO_DOMAIN=localhost \
            ./minio server minio-data --address :9000 --console-address :9001 &
          
          # Wait for MinIO to start
          sleep 5
          
          # Configure MinIO client
          ./mc alias set local http://localhost:9000 minioadmin minioadmin
          
          # Create test bucket
          ./mc mb local/test-bucket
          
          echo "MinIO S3 server is running on http://localhost:9000"
      - name: Populate S3 bucket with test data
        run: |
          # Download and extract Linux kernel source
          echo "Downloading Linux kernel source..."
          curl -L https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-6.12.63.tar.xz | tar -Jx
          
          # Upload Linux source tree to S3
          echo "Uploading Linux source to S3 bucket..."
          ./mc cp --recursive linux-6.12.63/ local/test-bucket/
          
          rm -rf linux-6.12.63
      - name: Test EROFS image built from S3
        run: |
          sudo apt -qq update
          sudo apt-get install -y libcurl4 libxml2 libssl-dev libelf-dev flex bison dwarves
          chmod +x bin/mkfs.erofs bin/fsck.erofs
          ./erofs-s3-test http://localhost:9000 test-bucket ${{ matrix.urlstyle }} ${{ matrix.sig }} minioadmin minioadmin "${{ matrix.opts }}"
      - name: Upload images if the test fails
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: erofs-s3-images-${{ matrix.urlstyle }}-sig${{ matrix.sig }}${{ matrix.opts }}
          path: '*.img'
      - name: Cleanup MinIO
        if: always()
        run: |
          pkill minio || true
